#!/bin/sh
#
# This tool is a piece of evil magic, which allows one to cross-bootstrap
# target userlands inside of Slind development chroot.
#
# There is a generic problem with bootstrapping when target != host
# architecture - some tools binary utilities are executed during packages
# installation. cross-shell allows to overcome this problem, by using
# LD_PRELOAD approach. Special Slind target rootfs is created with
# host == target and calls to binary utilities during bootstrapping are
# intercepted and executed in this specially created rootfs.
#
# The following commands are provided for cross-shell user:
#
# bs
#   Bootstrap target rootfs inside of development chroot
#
# sh
#   Execute single command in context of target rootfs
#
# apt
#   Run "apt-get update; apt-get install $*; apt-get clean" for target
#
# pack
#   Create a tar image of your target root filesystem
#

#set -x

CONF_GLOBAL=/etc/cross-shell.conf
CONF_LOCAL=~/.cross-shell
if [ -f $CONF_LOCAL ]; then
	. $CONF_LOCAL
else
	if [ -f $CONF_GLOBAL ]; then
		. $CONF_GLOBAL
	else
		echo "Cannot find any configuration file, exiting."
		exit 1
	fi
fi

DEBOOTSTRAP=/usr/sbin/debootstrap
BASEDIR=`pwd`
CROSS_ARCH=$ARCH
PATH=/usr/sbin:/sbin:${PATH}
LD_LIBRARY_PATH=/lib:/usr/lib
LD_PRELOAD=/usr/lib/fakechroot-cross/libfakechroot-cross.so:/usr/lib/libfakeroot/libfakeroot-sysv.so

export CROSS_ARCH PATH FAKECHROOT_CROSS LD_LIBRARY_PATH LD_PRELOAD

case "$1" in
	bs)
		# existing /proc generates strange errors during re-run of debootstrap
		test -L $WHERE/proc && rm $WHERE/proc
		if [ "${REPO#http*:}" = "$REPO" ]; then
			$DEBOOTSTRAP --components=core --arch $ARCH $SUITE $WHERE $REPO ${REPO#file://}/$SUITE
			ln -s $REPO $WHERE/repo
		else
			if ! [ -f $WHERE/repo/$SUITE ]; then
				mkdir -p $WHERE/repo
				cp /usr/lib/slind-core/debootstrap/$SUITE $WHERE/repo/$SUITE
			fi
			$DEBOOTSTRAP --components=core --arch $ARCH $SUITE $WHERE $REPO $WHERE/repo/$SUITE
		fi
		# configure apt
		echo "deb $REPO $SUITE core" > $WHERE/etc/apt/sources.list
		echo "APT::Architecture \"$ARCH\";" > $WHERE/etc/apt/apt.conf
		# configure target
		echo "# THIS IS DUMMY FSTAB GENERATED BY cross-shell FOR YOU" > $WHERE/etc/fstab
		echo "slind" > $WHERE/etc/hostname
		;;
	sh)
		shift
		_cmd="$*"
		$FAKECHROOT_CROSS/bin/busybox chroot $WHERE $_cmd
		;;
	apt)
		shift;
		_pkglist="$*"
		$FAKECHROOT_CROSS/bin/busybox chroot $WHERE /usr/bin/apt-get update
		$FAKECHROOT_CROSS/bin/busybox chroot $WHERE /usr/bin/apt-get install --yes --force-yes $_pkglist
		$FAKECHROOT_CROSS/bin/busybox chroot $WHERE /usr/bin/apt-get clean
		;;
	pack)
		unset LD_PRELOAD
		echo "# THIS IS DUMMY FSTAB GENERATED BY cross-shell FOR YOU" > $WHERE/etc/fstab
		echo "# THIS IS DUMMY INITTAB GENERATED BY cross-shell FOR YOU" > $WHERE/etc/inittab
		echo "slind" > $WHERE/etc/hostname
		
		# pack things
		( cd $WHERE; \
			tar cf /rootfs-$ARCH.tar \
				--exclude=debootstrap \
				--exclude=repo \
				--exclude=proc \
				--exclude=dev \
				--exclude='dev/*' * )
		mkdir proc
		tar rf rootfs-$ARCH.tar proc
		tar Af rootfs-$ARCH.tar /usr/lib/cross-shell/devs.tar
		rmdir proc
		;;
esac

